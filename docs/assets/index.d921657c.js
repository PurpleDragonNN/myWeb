var ye=Object.defineProperty,Ee=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var oe=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,Ue=Object.prototype.propertyIsEnumerable;var ne=(f,p,i)=>p in f?ye(f,p,{enumerable:!0,configurable:!0,writable:!0,value:i}):f[p]=i,re=(f,p)=>{for(var i in p||(p={}))ke.call(p,i)&&ne(f,i,p[i]);if(oe)for(var i of oe(p))Ue.call(p,i)&&ne(f,i,p[i]);return f},ie=(f,p)=>Ee(f,xe(p));import{_ as pe,d as ce,q as me,s as fe,G as y,r as m,v as O,w as M,a as g,o as z,c as ee,b as a,e as o,u as e,y as b,z as h,f as r,I as De,i as H,F as Fe,l as I,T as Pe,J as ue,N as q,B as Ie,t as X,j as Y,k as de,p as Ae,m as Ve,K as Re}from"./index.082d2721.js";import{c as qe}from"./index.8c4b825d.js";const Oe=["onKeydown"],ze=I("\u767B\u5F55"),Ne=I(" \u524D\u5F80\u6CE8\u518C "),Te=I("\u6CE8\u518C"),Se=I(" \u524D\u5F80\u767B\u5F55 "),$e=I("\u4FEE\u6539\u4FE1\u606F"),Le=I("\u4FEE\u6539\u5BC6\u7801"),Me=ce({emits:["loginCallback"],setup(f,{expose:p,emit:i}){const x=me(),{userInfo:A}=fe(x),k=new y.User,C=y.User.current()||new y.User;qe("_User");const j={202:"\u8BE5\u7528\u6237\u540D\u5DF2\u88AB\u6CE8\u518C",210:"\u8D26\u53F7\u6216\u5BC6\u7801\u9519\u8BEF",211:"\u8BE5\u7528\u6237\u4E0D\u5B58\u5728",214:"\u8BE5\u53F7\u7801\u5DF2\u88AB\u6CE8\u518C"};let c=m(!1),U=m(!1),v=m(!1),F=m(!1),D=m(!1),N=m([]),T=m([]),V=m(1024*500);const K=m(null),W=m(null),S=m(null),te=m(null);let $=m(null),R=m(null);const E=O({account:"",password:""}),d=O({username:"",password:"",phone:"",email:""}),n=O({username:"",oldPassword:"",newPassword:"",repeatPassword:"",phone:"",email:""});O({username:"",oldPassword:"",newPassword:"",repeatPassword:"",phone:"",email:""});const Z=u=>{j[u.code]?q.danger(j[u.code]):q.danger(u.rawMessage)},Q=u=>{U.value=u,v.value=!u},w=O({username:[{required:!0,message:"\u8BF7\u8F93\u5165\u7528\u6237\u540D"}],account:[{required:!0,message:"\u8BF7\u8F93\u5165\u7528\u6237\u540D\u6216\u90AE\u7BB1"}],password:[{required:!0,message:"\u8BF7\u8F93\u5165\u5BC6\u7801"}],repeatPassword:[{required:!0,message:"\u8BF7\u518D\u6B21\u8F93\u5165\u5BC6\u7801"},{validator:u=>n.newPassword===n.repeatPassword,message:"\u4E24\u6B21\u8F93\u5165\u7684\u5BC6\u7801\u4E0D\u4E00\u81F4"}],email:[{required:!1,message:"\u8BF7\u8F93\u5165\u90AE\u7BB1"},{validator:u=>!u||/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/.test(u),message:"\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E"}],phone:[{validator:u=>!u||/^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d{8}$/.test(u),message:"\u624B\u673A\u53F7\u7801\u683C\u5F0F\u4E0D\u6B63\u786E"}]});M(N,u=>{u.length?u[0].status="success":$.value=null},{deep:!0}),M(T,u=>{u.length?u[0].status="success":R.value=null},{deep:!0}),M(A,u=>{u&&(n.username=u.username,n.phone=u.mobilePhoneNumber,n.email=u.email,u.headImg&&(R.value=u.headImg,T.value[0]=ie(re({},u.headImg),{status:"success",type:"image",message:"\u6210\u529F"})))},{immediate:!0,deep:!0}),M(()=>F.value,u=>{});const _e=()=>{K.value.validate().then(({valid:u,errors:t})=>{u?ge():console.log("error submit!!",t)})},le=()=>{W.value.validate().then(({valid:u,errors:t})=>{u?(c.value=!0,y.User.logIn(E.account,E.password).then(l=>{c.value=!1,v.value=!1,i("loginCallback",l),E.account="",E.password=""}).catch(l=>{c.value=!1,Z(l)})):console.log("error submit!!",t)})},ge=()=>{k.setUsername(d.username),k.setPassword(d.password),d.phone&&k.setMobilePhoneNumber(d.phone),d.email&&k.setEmail(d.email),$.value&&k.set("headImg",new y.File($.value.name,$.value)),c.value=!0,k.signUp().then(()=>{c.value=!1,Pe.success("\u6CE8\u518C\u6210\u529F\uFF0C\u6B63\u5728\u524D\u5F80\u767B\u5F55"),setTimeout(()=>{Q(!1),d.username="",d.password="",d.phone="",d.email=""},2e3)}).catch(u=>{c.value=!1,Z(u)})},ve=()=>{S.value.validate().then(({valid:u,errors:t})=>{u?ue({content:"\u786E\u8BA4\u4FEE\u6539\u4FE1\u606F\uFF1F",teleport:".ignore-container",popStyle:{"z-index":2222},overlayStyle:{"z-index":2222},onOk:()=>{C.setUsername(n.username),C.setMobilePhoneNumber(n.phone),n.email&&C.setEmail(n.email);let l=Object.prototype.toString.call(R.value);l==="[object File]"?C.set("headImg",new y.File(R.value.name,R.value)):l==="[object Null]"&&C.unset("headImg"),c.value=!0,C.save().then(()=>{c.value=!1,x.fetchUserInfo(),F.value=!1,q.success("\u4FEE\u6539\u6210\u529F")}).catch(_=>{c.value=!1,Z(_)})},onClosed:()=>{console.log(234234)}}):console.log("error submit!!",t)})},we=()=>{te.value.validate().then(({valid:u,errors:t})=>{u?ue({content:"\u4FEE\u6539\u5BC6\u7801\u540E\u9700\u8981\u91CD\u65B0\u767B\u5F55\uFF0C\u786E\u8BA4\u4FEE\u6539\uFF1F",onOk:()=>{c.value=!0,C.updatePassword(n.oldPassword,n.newPassword,{sessionToken:C.getSessionToken(),user:C,useMasterKey:!0}).then(()=>{c.value=!1,q.success("\u4FEE\u6539\u5BC6\u7801\u6210\u529F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55"),D.value=!1,y.User.logOut().then(l=>{x.fetchUserInfo()})}).catch(l=>{c.value=!1,l.code===210?q.danger("\u65E7\u5BC6\u7801\u9519\u8BEF"):Z(l)})}}):console.log("error submit!!",t)})},se=async u=>{if(u[0].size>V.value)return q.danger(`\u56FE\u7247\u5927\u5C0F\u4E0D\u80FD\u8D85\u8FC7${V.value/1024}kb\uFF01`),u;let t=F?R:$;return u[0].size>1024*100&&Be(u).then(l=>(t.value=l[0],l)),t.value=u[0],[u[0]]},Be=async u=>{let t=u[0].name;const l=document.createElement("canvas"),_=l.getContext("2d"),P=await be(u[0]),B=await he(P);l.width=B.width,l.height=B.height,_.clearRect(0,0,B.width,B.height),_.drawImage(B,0,0,B.width,B.height);let G=await Ce(l,"image/jpeg",.5);return[await new File([G],t)]},be=u=>new Promise(t=>{const l=new FileReader;l.onloadend=_=>t(_.target.result),l.readAsDataURL(u)}),he=u=>new Promise(t=>{const l=new Image;l.onload=()=>t(l),l.src=u}),Ce=(u,t,l)=>new Promise(_=>u.toBlob(P=>_(P),t,l));return p({logVisible:v,regVisible:U,updateVisible:F,updatePWVisible:D}),(u,t)=>{const l=g("nut-form-item"),_=g("nut-button"),P=g("nut-cell"),B=g("nut-form"),G=g("nut-icon"),L=g("nut-dialog"),ae=g("nut-uploader");return z(),ee(Fe,null,[a(L,{"no-footer":!0,closeOnClickOverlay:"",visible:e(v),"onUpdate:visible":t[3]||(t[3]=s=>H(v)?v.value=s:v=s),title:"\u767B \u5F55"},{default:o(()=>[a(B,{"model-value":e(E),ref_key:"loginRef",ref:W},{default:o(()=>[a(l,{label:"\u8D26\u53F7","label-width":"60px",prop:"account",required:"",rules:e(w).account},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[0]||(t[0]=s=>e(E).account=s),placeholder:"\u8BF7\u8F93\u5165\u7528\u6237\u540D\u6216\u90AE\u7BB1",type:"text"},null,512),[[h,e(E).account]])]),_:1},8,["rules"]),a(l,{label:"\u5BC6\u7801","label-width":"60px",prop:"password",required:"",rules:e(w).password},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[1]||(t[1]=s=>e(E).password=s),onKeydown:De(le,["enter"]),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,40,Oe),[[h,e(E).password]])]),_:1},8,["rules"]),a(P,null,{default:o(()=>[a(_,{loading:e(c),type:"primary",block:"",onClick:le},{default:o(()=>[ze]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"]),r("div",{class:"text-btn",onClick:t[2]||(t[2]=s=>Q(!0))},[Ne,a(G,{name:"arrow-right"})])]),_:1},8,["visible"]),a(L,{"no-footer":!0,closeOnClickOverlay:"",visible:e(U),"onUpdate:visible":t[9]||(t[9]=s=>H(U)?U.value=s:U=s),class:"info-dialog"},{default:o(()=>[a(ae,{"file-list":e(N),"before-upload":se,accept:"image/*","auto-upload":!1,maximize:e(V)},null,8,["file-list","maximize"]),a(B,{"model-value":e(d),ref_key:"registerRef",ref:K,class:"register-form"},{default:o(()=>[a(l,{label:"\u7528\u6237\u540D","label-width":"70px",prop:"username",required:"",rules:e(w).username},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[4]||(t[4]=s=>e(d).username=s),placeholder:"\u8BF7\u8F93\u5165\u59D3\u540D",type:"text"},null,512),[[h,e(d).username]])]),_:1},8,["rules"]),a(l,{label:"\u5BC6\u7801","label-width":"70px",prop:"password",required:"",rules:e(w).password},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[5]||(t[5]=s=>e(d).password=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[h,e(d).password]])]),_:1},8,["rules"]),a(l,{label:"\u624B\u673A\u53F7\u7801","label-width":"70px",prop:"phone",rules:e(w).phone},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[6]||(t[6]=s=>e(d).phone=s),placeholder:"\u8BF7\u8F93\u5165\u624B\u673A\u53F7\u7801",type:"text"},null,512),[[h,e(d).phone]])]),_:1},8,["rules"]),a(l,{label:"\u90AE\u7BB1","label-width":"40px",prop:"email",rules:e(w).email},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[7]||(t[7]=s=>e(d).email=s),placeholder:"\u8BF7\u8F93\u5165\u90AE\u7BB1",type:"email"},null,512),[[h,e(d).email]])]),_:1},8,["rules"]),a(P,null,{default:o(()=>[a(_,{block:"",class:"register-btn",type:"primary",onClick:_e},{default:o(()=>[Te]),_:1})]),_:1}),r("div",{class:"text-btn",onClick:t[8]||(t[8]=s=>Q(!1))},[Se,a(G,{name:"arrow-right"})])]),_:1},8,["model-value"])]),_:1},8,["visible"]),a(L,{"no-footer":!0,closeOnClickOverlay:"",visible:e(F),"onUpdate:visible":t[13]||(t[13]=s=>H(F)?F.value=s:F=s),class:"info-dialog"},{default:o(()=>[a(ae,{"file-list":e(T),"before-upload":se,accept:"image/*","auto-upload":!1,maximize:e(V)},null,8,["file-list","maximize"]),a(B,{"model-value":e(n),ref_key:"updateRef",ref:S,class:"register-form"},{default:o(()=>[a(l,{label:"\u7528\u6237\u540D","label-width":"70px",prop:"username",required:"",rules:e(w).username},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[10]||(t[10]=s=>e(n).username=s),placeholder:"\u8BF7\u8F93\u5165\u59D3\u540D",type:"text"},null,512),[[h,e(n).username]])]),_:1},8,["rules"]),a(l,{label:"\u624B\u673A\u53F7\u7801","label-width":"70px",prop:"phone",rules:e(w).phone},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[11]||(t[11]=s=>e(n).phone=s),placeholder:"\u8BF7\u8F93\u5165\u624B\u673A\u53F7\u7801",type:"text"},null,512),[[h,e(n).phone]])]),_:1},8,["rules"]),a(l,{label:"\u90AE\u7BB1","label-width":"40px",prop:"email",rules:e(w).email},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[12]||(t[12]=s=>e(n).email=s),placeholder:"\u8BF7\u8F93\u5165\u90AE\u7BB1",type:"email"},null,512),[[h,e(n).email]])]),_:1},8,["rules"]),a(P,null,{default:o(()=>[a(_,{loading:e(c),block:"",class:"register-btn",type:"primary",onClick:ve},{default:o(()=>[$e]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"])]),_:1},8,["visible"]),a(L,{"no-footer":!0,closeOnClickOverlay:"",visible:e(D),"onUpdate:visible":t[17]||(t[17]=s=>H(D)?D.value=s:D=s)},{default:o(()=>[a(B,{"model-value":e(n),ref_key:"updatePWRef",ref:te},{default:o(()=>[a(l,{label:"\u65E7\u5BC6\u7801","label-width":"80px",prop:"oldPassword",required:"",rules:e(w).password},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[14]||(t[14]=s=>e(n).oldPassword=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[h,e(n).oldPassword]])]),_:1},8,["rules"]),a(l,{label:"\u65B0\u5BC6\u7801","label-width":"80px",prop:"newPassword",required:"",rules:e(w).password},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[15]||(t[15]=s=>e(n).newPassword=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[h,e(n).newPassword]])]),_:1},8,["rules"]),a(l,{label:"\u786E\u8BA4\u5BC6\u7801","label-width":"80px",prop:"repeatPassword",required:"",rules:e(w).repeatPassword},{default:o(()=>[b(r("input",{class:"nut-input-text","onUpdate:modelValue":t[16]||(t[16]=s=>e(n).repeatPassword=s),placeholder:"\u8BF7\u518D\u6B21\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[h,e(n).repeatPassword]])]),_:1},8,["rules"]),a(P,null,{default:o(()=>[a(_,{loading:e(c),block:"",class:"register-btn",type:"primary",onClick:we},{default:o(()=>[Le]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"])]),_:1},8,["visible"])],64)}}});var je=pe(Me,[["__scopeId","data-v-466b55e3"]]);const J=f=>(Ae("data-v-3d81f5f1"),f=f(),Ve(),f),Ke={key:0,class:"container"},We={class:"username"},Ze=J(()=>r("i",{class:"iconfont icon-phone"},null,-1)),Ge=J(()=>r("i",{class:"iconfont icon-email"},null,-1)),He=J(()=>r("br",null,null,-1)),Je={style:{"margin-top":"10px"}},Qe=J(()=>r("i",{class:"iconfont icon-login"},null,-1)),Xe=I(" \u767B\u5F55"),Ye=ce({setup(f){const p=me(),{userInfo:i}=fe(p),x=m(!1),A=m(null);y.User.current()||new y.User,O({new:"",old:""}),M(i,async v=>{v||(await Re(),c())},{immediate:!0,deep:!0});const k=()=>{ue({content:"\u786E\u8BA4\u9000\u51FA\u5F53\u524D\u767B\u5F55\uFF1F",onOk:()=>{y.User.logOut().then(()=>{p.fetchUserInfo()})}})},C=v=>{v.event(),x.value=!1},j=[{name:"\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F",event:()=>{A.value.updateVisible=!0}},{name:"\u4FEE\u6539\u5BC6\u7801",event:()=>{A.value.updatePWVisible=!0}},{name:"\u6CE8\u9500\u767B\u5F55",event:k}],c=()=>{A.value.logVisible=!0},U=()=>{p.fetchUserInfo()};return Ie(()=>{}),(v,F)=>{const D=g("nut-avatar"),N=g("nut-cell"),T=g("nut-cell-group"),V=g("nut-button"),K=g("nut-empty"),W=g("nut-actionsheet");return z(),ee(Fe,null,[a(je,{ref_key:"entryRef",ref:A,onLoginCallback:U},null,512),e(i)?(z(),ee("div",Ke,[r("i",{onClick:F[0]||(F[0]=S=>x.value=!0),class:"iconfont icon-setting"}),a(D,{size:"60",icon:e(i).headImg?e(i).headImg.url:"my",shape:"square"},null,8,["icon"]),r("span",We,X(e(i).username),1),a(T,{class:"info-group"},{default:o(()=>[e(i).mobilePhoneNumber?(z(),Y(N,{key:0},{default:o(()=>[Ze,r("span",null,X(e(i).mobilePhoneNumber),1)]),_:1})):de("",!0),e(i).email?(z(),Y(N,{key:1},{default:o(()=>[Ge,r("span",null,X(e(i).email),1)]),_:1})):de("",!0),He]),_:1})])):(z(),Y(K,{key:1,image:"empty",description:"\u672A\u767B\u5F55"},{default:o(()=>[r("div",Je,[a(V,{type:"primary",onClick:c},{default:o(()=>[Qe,Xe]),_:1})])]),_:1})),a(W,{visible:x.value,"onUpdate:visible":F[1]||(F[1]=S=>x.value=S),"menu-items":j,onChoose:C},null,8,["visible"])],64)}}});var lu=pe(Ye,[["__scopeId","data-v-3d81f5f1"]]);export{lu as default};
