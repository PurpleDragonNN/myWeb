var Ce=Object.defineProperty,Ee=Object.defineProperties;var ye=Object.getOwnPropertyDescriptors;var ae=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var oe=(p,d,i)=>d in p?Ce(p,d,{enumerable:!0,configurable:!0,writable:!0,value:i}):p[d]=i,ne=(p,d)=>{for(var i in d||(d={}))xe.call(d,i)&&oe(p,i,d[i]);if(ae)for(var i of ae(d))ke.call(d,i)&&oe(p,i,d[i]);return p},re=(p,d)=>Ee(p,ye(d));import{A as E,d as de,m as pe,s as ce,r as m,j as S,k as K,a as _,o as O,c as ee,b as a,w as o,u as e,l as h,v as C,e as r,i as H,n as A,T as Ue,_ as ue,N as q,q as De,x as Pe,t as X,y as Y,F as Ie,f as ie,p as Ae,g as Ve,z as Re}from"./index.aaa57f16.js";import{_ as me}from"./plugin-vue_export-helper.21dcd24c.js";const qe=p=>new E.Query(p);const Oe=A("\u767B\u5F55"),Ne=A(" \u524D\u5F80\u6CE8\u518C "),Te=A("\u6CE8\u518C"),ze=A(" \u524D\u5F80\u767B\u5F55 "),Le=A("\u4FEE\u6539\u4FE1\u606F"),$e=A("\u4FEE\u6539\u5BC6\u7801"),Se=de({emits:["loginCallback"],setup(p,{expose:d,emit:i}){const y=pe(),{userInfo:P}=ce(y),x=new E.User,g=E.User.current()||new E.User;qe("_User");const M={202:"\u8BE5\u7528\u6237\u540D\u5DF2\u88AB\u6CE8\u518C",210:"\u8D26\u53F7\u6216\u5BC6\u7801\u9519\u8BEF",211:"\u8BE5\u7528\u6237\u4E0D\u5B58\u5728",214:"\u8BE5\u53F7\u7801\u5DF2\u88AB\u6CE8\u518C"};let c=m(!1),k=m(!1),v=m(!1),b=m(!1),U=m(!1),N=m([]),T=m([]),V=m(1024*500);const j=m(null),W=m(null),z=m(null),te=m(null);let L=m(null),R=m(null);const I=S({account:"",password:""}),f=S({username:"",password:"",phone:"",email:""}),n=S({username:"",oldPassword:"",newPassword:"",repeatPassword:"",phone:"",email:""}),Z=t=>{M[t.code]?q.danger(M[t.code]):q.danger(t.rawMessage)},J=t=>{k.value=t,v.value=!t},B=S({username:[{required:!0,message:"\u8BF7\u8F93\u5165\u7528\u6237\u540D"}],account:[{required:!0,message:"\u8BF7\u8F93\u5165\u7528\u6237\u540D\u6216\u90AE\u7BB1"}],password:[{required:!0,message:"\u8BF7\u8F93\u5165\u5BC6\u7801"}],repeatPassword:[{required:!0,message:"\u8BF7\u518D\u6B21\u8F93\u5165\u5BC6\u7801"},{validator:t=>n.newPassword===n.repeatPassword,message:"\u4E24\u6B21\u8F93\u5165\u7684\u5BC6\u7801\u4E0D\u4E00\u81F4"}],email:[{required:!1,message:"\u8BF7\u8F93\u5165\u90AE\u7BB1"},{validator:t=>!t||/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/.test(t),message:"\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E"}],phone:[{validator:t=>!t||/^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d{8}$/.test(t),message:"\u624B\u673A\u53F7\u7801\u683C\u5F0F\u4E0D\u6B63\u786E"}]});K(N,t=>{t.length?t[0].status="success":L.value=null},{deep:!0}),K(T,t=>{console.log(t),t.length?t[0].status="success":R.value=null},{deep:!0}),K(P,t=>{console.log("en:",P),t&&(n.username=t.username,n.phone=t.mobilePhoneNumber,n.email=t.email,t.headImg&&(R.value=t.headImg,T.value[0]=re(ne({},t.headImg),{status:"success",type:"image",message:"\u6210\u529F"})))},{immediate:!0,deep:!0});const fe=()=>{j.value.validate().then(({valid:t,errors:u})=>{t?_e():console.log("error submit!!",u)})},Fe=()=>{W.value.validate().then(({valid:t,errors:u})=>{t?(c.value=!0,E.User.logIn(I.account,I.password).then(l=>{c.value=!1,v.value=!1,i("loginCallback",l)}).catch(l=>{c.value=!1,Z(l)})):console.log("error submit!!",u)})},_e=()=>{x.setUsername(f.username),x.setPassword(f.password),x.setMobilePhoneNumber(f.phone),f.email&&x.setEmail(f.email),L.value&&x.set("headImg",new E.File(L.value.name,L.value)),c.value=!0,x.signUp().then(()=>{c.value=!1,Ue.success("\u6CE8\u518C\u6210\u529F\uFF0C\u6B63\u5728\u524D\u5F80\u767B\u5F55"),setTimeout(()=>{J(!1)},2e3)}).catch(t=>{Z(t)})},ge=()=>{z.value.validate().then(({valid:t,errors:u})=>{t?ue({content:"\u786E\u8BA4\u4FEE\u6539\u4FE1\u606F\uFF1F",onOk:()=>{g.setUsername(n.username),g.setMobilePhoneNumber(n.phone),n.email&&g.setEmail(n.email);let l=Object.prototype.toString.call(R.value);l==="[object File]"?g.set("headImg",new E.File(R.value.name,R.value)):l==="[object Null]"&&g.unset("headImg"),c.value=!0,console.log(g),g.save().then(()=>{c.value=!1,y.fetchUserInfo(),b.value=!1,q.success("\u4FEE\u6539\u6210\u529F")}).catch(F=>{c.value=!1,Z(F)})}}):console.log("error submit!!",u)})},ve=()=>{te.value.validate().then(({valid:t,errors:u})=>{t?ue({content:"\u4FEE\u6539\u5BC6\u7801\u540E\u9700\u8981\u91CD\u65B0\u767B\u5F55\uFF0C\u786E\u8BA4\u4FEE\u6539\uFF1F",onOk:()=>{c.value=!0,g.updatePassword(n.oldPassword,n.newPassword,{sessionToken:g.getSessionToken(),user:g,useMasterKey:!0}).then(()=>{c.value=!1,q.success("\u4FEE\u6539\u5BC6\u7801\u6210\u529F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55"),U.value=!1,E.User.logOut().then(l=>{y.fetchUserInfo()})}).catch(l=>{c.value=!1,l.code===210?q.danger("\u65E7\u5BC6\u7801\u9519\u8BEF"):Z(l)})}}):console.log("error submit!!",u)})},le=async t=>{if(t[0].size>V.value)return q.danger(`\u56FE\u7247\u5927\u5C0F\u4E0D\u80FD\u8D85\u8FC7${V.value/1024}kb\uFF01`),t;let u=b?R:L;return t[0].size>1024*100&&be(t).then(l=>(u.value=l[0],console.log("compress:",l),l)),u.value=t[0],console.log(u.value),[t[0]]},be=async t=>{let u=t[0].name;const l=document.createElement("canvas"),F=l.getContext("2d"),D=await Be(t[0]),w=await we(D);l.width=w.width,l.height=w.height,F.clearRect(0,0,w.width,w.height),F.drawImage(w,0,0,w.width,w.height);let Q=await he(l,"image/jpeg",.5);return[await new File([Q],u)]},Be=t=>new Promise(u=>{const l=new FileReader;l.onloadend=F=>u(F.target.result),l.readAsDataURL(t)}),we=t=>new Promise(u=>{const l=new Image;l.onload=()=>u(l),l.src=t}),he=(t,u,l)=>new Promise(F=>t.toBlob(D=>F(D),u,l));return d({logVisible:v,regVisible:k,updateVisible:b,updatePWVisible:U}),(t,u)=>{const l=_("nut-form-item"),F=_("nut-button"),D=_("nut-cell"),w=_("nut-form"),Q=_("nut-icon"),$=_("nut-dialog"),se=_("nut-uploader");return O(),ee("div",null,[a($,{"no-footer":!0,closeOnClickOverlay:"",visible:e(v),"onUpdate:visible":u[3]||(u[3]=s=>H(v)?v.value=s:v=s),title:"\u767B \u5F55"},{default:o(()=>[a(w,{"model-value":e(I),ref_key:"loginRef",ref:W},{default:o(()=>[a(l,{label:"\u8D26\u53F7","label-width":"60px",prop:"account",required:"",rules:e(B).account},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[0]||(u[0]=s=>e(I).account=s),placeholder:"\u8BF7\u8F93\u5165\u7528\u6237\u540D\u6216\u90AE\u7BB1",type:"text"},null,512),[[C,e(I).account]])]),_:1},8,["rules"]),a(l,{label:"\u5BC6\u7801","label-width":"60px",prop:"password",required:"",rules:e(B).password},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[1]||(u[1]=s=>e(I).password=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[C,e(I).password]])]),_:1},8,["rules"]),a(D,null,{default:o(()=>[a(F,{loading:e(c),type:"primary",block:"",onClick:Fe},{default:o(()=>[Oe]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"]),r("div",{class:"text-btn",onClick:u[2]||(u[2]=s=>J(!0))},[Ne,a(Q,{name:"arrow-right"})])]),_:1},8,["visible"]),a($,{"no-footer":!0,closeOnClickOverlay:"",visible:e(k),"onUpdate:visible":u[9]||(u[9]=s=>H(k)?k.value=s:k=s),class:"info-dialog"},{default:o(()=>[a(se,{"file-list":e(N),"before-upload":le,accept:"image/*","auto-upload":!1,maximize:e(V)},null,8,["file-list","maximize"]),a(w,{"model-value":e(f),ref_key:"registerRef",ref:j,class:"register-form"},{default:o(()=>[a(l,{label:"\u7528\u6237\u540D","label-width":"70px",prop:"username",required:"",rules:e(B).username},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[4]||(u[4]=s=>e(f).username=s),placeholder:"\u8BF7\u8F93\u5165\u59D3\u540D",type:"text"},null,512),[[C,e(f).username]])]),_:1},8,["rules"]),a(l,{label:"\u5BC6\u7801","label-width":"70px",prop:"password",required:"",rules:e(B).password},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[5]||(u[5]=s=>e(f).password=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[C,e(f).password]])]),_:1},8,["rules"]),a(l,{label:"\u624B\u673A\u53F7\u7801","label-width":"70px",prop:"phone",rules:e(B).phone},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[6]||(u[6]=s=>e(f).phone=s),placeholder:"\u8BF7\u8F93\u5165\u624B\u673A\u53F7\u7801",type:"text"},null,512),[[C,e(f).phone]])]),_:1},8,["rules"]),a(l,{label:"\u90AE\u7BB1","label-width":"40px",prop:"email",rules:e(B).email},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[7]||(u[7]=s=>e(f).email=s),placeholder:"\u8BF7\u8F93\u5165\u90AE\u7BB1",type:"email"},null,512),[[C,e(f).email]])]),_:1},8,["rules"]),a(D,null,{default:o(()=>[a(F,{block:"",class:"register-btn",type:"primary",onClick:fe},{default:o(()=>[Te]),_:1})]),_:1}),r("div",{class:"text-btn",onClick:u[8]||(u[8]=s=>J(!1))},[ze,a(Q,{name:"arrow-right"})])]),_:1},8,["model-value"])]),_:1},8,["visible"]),a($,{"no-footer":!0,closeOnClickOverlay:"",visible:e(b),"onUpdate:visible":u[13]||(u[13]=s=>H(b)?b.value=s:b=s),class:"info-dialog"},{default:o(()=>[a(se,{"file-list":e(T),"before-upload":le,accept:"image/*","auto-upload":!1,maximize:e(V)},null,8,["file-list","maximize"]),a(w,{"model-value":e(n),ref_key:"updateRef",ref:z,class:"register-form"},{default:o(()=>[a(l,{label:"\u7528\u6237\u540D","label-width":"70px",prop:"username",required:"",rules:e(B).username},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[10]||(u[10]=s=>e(n).username=s),placeholder:"\u8BF7\u8F93\u5165\u59D3\u540D",type:"text"},null,512),[[C,e(n).username]])]),_:1},8,["rules"]),a(l,{label:"\u624B\u673A\u53F7\u7801","label-width":"70px",prop:"phone",rules:e(B).phone},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[11]||(u[11]=s=>e(n).phone=s),placeholder:"\u8BF7\u8F93\u5165\u624B\u673A\u53F7\u7801",type:"text"},null,512),[[C,e(n).phone]])]),_:1},8,["rules"]),a(l,{label:"\u90AE\u7BB1","label-width":"40px",prop:"email",rules:e(B).email},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[12]||(u[12]=s=>e(n).email=s),placeholder:"\u8BF7\u8F93\u5165\u90AE\u7BB1",type:"email"},null,512),[[C,e(n).email]])]),_:1},8,["rules"]),a(D,null,{default:o(()=>[a(F,{loading:e(c),block:"",class:"register-btn",type:"primary",onClick:ge},{default:o(()=>[Le]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"])]),_:1},8,["visible"]),a($,{"no-footer":!0,closeOnClickOverlay:"",visible:e(U),"onUpdate:visible":u[17]||(u[17]=s=>H(U)?U.value=s:U=s)},{default:o(()=>[a(w,{"model-value":e(n),ref_key:"updatePWRef",ref:te},{default:o(()=>[a(l,{label:"\u65E7\u5BC6\u7801","label-width":"80px",prop:"oldPassword",required:"",rules:e(B).password},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[14]||(u[14]=s=>e(n).oldPassword=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[C,e(n).oldPassword]])]),_:1},8,["rules"]),a(l,{label:"\u65B0\u5BC6\u7801","label-width":"80px",prop:"newPassword",required:"",rules:e(B).password},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[15]||(u[15]=s=>e(n).newPassword=s),placeholder:"\u8BF7\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[C,e(n).newPassword]])]),_:1},8,["rules"]),a(l,{label:"\u786E\u8BA4\u5BC6\u7801","label-width":"80px",prop:"repeatPassword",required:"",rules:e(B).repeatPassword},{default:o(()=>[h(r("input",{class:"nut-input-text","onUpdate:modelValue":u[16]||(u[16]=s=>e(n).repeatPassword=s),placeholder:"\u8BF7\u518D\u6B21\u8F93\u5165\u5BC6\u7801",type:"password"},null,512),[[C,e(n).repeatPassword]])]),_:1},8,["rules"]),a(D,null,{default:o(()=>[a(F,{loading:e(c),block:"",class:"register-btn",type:"primary",onClick:ve},{default:o(()=>[$e]),_:1},8,["loading"])]),_:1})]),_:1},8,["model-value"])]),_:1},8,["visible"])])}}});var Me=me(Se,[["__scopeId","data-v-1bb0b198"]]);const G=p=>(Ae("data-v-2853171d"),p=p(),Ve(),p),je={key:0,class:"container"},We={class:"username"},Ze=G(()=>r("i",{class:"iconfont icon-phone"},null,-1)),Qe=G(()=>r("i",{class:"iconfont icon-email"},null,-1)),He=G(()=>r("br",null,null,-1)),Ke={style:{"margin-top":"10px"}},Ge=G(()=>r("i",{class:"iconfont icon-login"},null,-1)),Je=A(" \u767B\u5F55"),Xe=de({setup(p){const d=pe(),i=ce(d).userInfo,y=m(!1),P=m(null);E.User.current()||new E.User,S({new:"",old:""}),K(i,async v=>{v||(await Re(),c())},{immediate:!0,deep:!0});const x=()=>{ue({content:"\u786E\u8BA4\u9000\u51FA\u5F53\u524D\u767B\u5F55\uFF1F",onOk:()=>{E.User.logOut().then(()=>{d.fetchUserInfo()})}})},g=v=>{v.event(),y.value=!1},M=[{name:"\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F",event:()=>{P.value.updateVisible=!0}},{name:"\u4FEE\u6539\u5BC6\u7801",event:()=>{P.value.updatePWVisible=!0}},{name:"\u6CE8\u9500\u767B\u5F55",event:x}],c=()=>{P.value.logVisible=!0},k=()=>{d.fetchUserInfo()};return De(()=>{}),(v,b)=>{const U=_("nut-avatar"),N=_("nut-cell"),T=_("nut-cell-group"),V=_("nut-button"),j=_("nut-empty"),W=_("nut-actionsheet");return O(),ee(Ie,null,[a(Me,{ref_key:"entryRef",ref:P,onLoginCallback:k},null,512),e(i)?(O(),ee("div",je,[r("i",{onClick:b[0]||(b[0]=z=>y.value=!0),class:"iconfont icon-setting"}),a(U,{size:"60",icon:e(i).headImg?e(Pe)(e(i).headImg.url):"my",shape:"square"},null,8,["icon"]),r("span",We,X(e(i).username),1),a(T,{class:"info-group"},{default:o(()=>[e(i).mobilePhoneNumber?(O(),Y(N,{key:0},{default:o(()=>[Ze,r("span",null,X(e(i).mobilePhoneNumber),1)]),_:1})):ie("",!0),e(i).email?(O(),Y(N,{key:1},{default:o(()=>[Qe,r("span",null,X(e(i).email),1)]),_:1})):ie("",!0),He]),_:1})])):(O(),Y(j,{key:1,image:"empty",description:"\u672A\u767B\u5F55"},{default:o(()=>[r("div",Ke,[a(V,{type:"primary",onClick:c},{default:o(()=>[Ge,Je]),_:1})])]),_:1})),a(W,{visible:y.value,"onUpdate:visible":b[1]||(b[1]=z=>y.value=z),"menu-items":M,onChoose:g},null,8,["visible"])],64)}}});var tu=me(Xe,[["__scopeId","data-v-2853171d"]]);export{tu as default};
